<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>시간표</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 18px; background:#f7f9fc;}
        .topbar { display:flex; align-items:center; gap:10px; margin-bottom: 12px; }
        .topbar input { padding:6px 8px; width: 280px; }
        .topbar button { padding:6px 10px; cursor:pointer; }

        .layout {
            display: grid;
            /*grid-template-columns: 1.5fr 1.8fr;*/
            grid-template-columns: max-content minmax(0, 1fr);
            grid-template-rows: 1fr 0.55fr;
            gap: 18px;
            height: calc(100vh - 90px);
        }

        .panel {
            border-radius: 8px;
            background: #f3f7ff;
            padding: 14px;
            min-width: 0;      /* grid에서 overflow/축소 가능하게 */
            overflow: hidden;
        }

        .panel h2 { margin: 0 0 10px 0; font-size: 22px; }
        .course-pill{
            padding: 8px 10px;
            border-radius: 8px;
            margin: 4px 0;
            border: 1px solid rgba(0,0,0,0.08);
        }

        .course-pill.cont{
            /* 위 칸이랑 붙어 보이게 */
            margin-top: -6px;          /* 위 pill과 겹치게 */
            border-top: 0;             /* 위 경계선 제거 */
            border-top-left-radius: 0; /* 위 모서리 각지게 */
            border-top-right-radius: 0;
        }

        .course-pill.cont span{
            visibility: hidden;        /* 글자는 숨기되 높이는 유지 */
        }
        .period-time {
            font-size: 11px;
            color: #8b94a7;
            font-weight: normal;
            margin-top: 2px;
        }

        .slot-label {
            font-weight: normal; /*얇게 변경...*/
            color: #444;
        }

        .course-row, .picked-row {
            display:flex; align-items:center; justify-content:space-between;
            background: rgba(255,255,255,0.8);
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            gap: 10px;
        }

        .course-row .meta, .picked-row .meta { font-size: 13px; color:#333; }
        .course-row button, .picked-row button { padding: 6px 10px; cursor:pointer; }

        /* timetable grid (시간표 전용) */
        .timetable-grid {
            width : max-content;
            /*width:400px;*/
            table-layout: fixed;
            border-collapse: collapse;
            background:white;
        }
        .timetable-grid th, .timetable-grid td { width: 90px; border:1px solid #cfd6e3; padding:6px; vertical-align: top; }
        .timetable-grid th { background:#f6f8fc; position: sticky; top:0; z-index:2; }
        .timetable-grid .pcol { position: sticky; left:0; z-index:3; background:#f6f8fc; }

        .cell { font-size: 12px; line-height: 1.25; min-height: 40px; }
        .conflict { background: #ffe3e3; }
        .small { font-size: 12px; color:#444; }
        .course-chip{
            padding: 6px 8px;
            border-radius: 6px;
            margin: 4px 0;
        }

        .course-chip.cont{
            /* 글자 숨겨서 높이만 유지 */
            color: transparent;
        }
        .excel-table {
            width: 100%;
            min-width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 13px;
            table-layout:fixed;
        }
        .excel-table th,
        .excel-table td {
            border: 1px solid #cfd6e3;
            padding: 8px 10px;
            text-align: left;
            vertical-align: middle;

            white-space: nowrap; /* 한 줄 유지 */
            overflow:hidden; /* 넘치는 텍스트 숨기기 */
            /*text-overflow:ellipsis; !* ... 표시 *!*/
        }
        .excel-table th {
            background: #f6f8fc;
            position: sticky;
            top: 0;
            z-index: 2;
            font-weight: 700;
        }

        .truncate {
            max-width: 220px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .excel-table tbody tr { cursor: pointer; }
        .excel-table tbody tr:hover { background: #eef4ff; }

        /* 이미 담긴 과목은 회색 처리 */
        .excel-table tbody tr.picked {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .excel-table tbody tr.picked:hover {
            background: inherit;
        }

        .course-list-panel .table-wrap{
            height: 100%;
            max-height: 100%;
            overflow: auto;       /* 스크롤 */
        }

        .table-wrap {
            overflow-x: auto;
            overflow-y: auto;

            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>

<div class="topbar">
    <div class="small">timetableId: <span th:text="${timetable.id}"></span></div>

    <form th:action="@{|/timetable/${timetable.id}/title|}" method="post" style="display:flex; gap:8px; align-items:center;">
        <input type="text" name="title" th:value="${timetable.title}" />
        <button type="submit">제목 수정</button>
    </form>

    <form th:action="@{|/timetable/${timetable.id}/save|}" method="post">
        <button type="submit">저장</button>
    </form>
</div>

<div class="layout">

    <!-- 강의 목록 -->
    <div class="panel course-list-panel">
        <h2>강의 목록</h2>

        <div class="small" style="margin-bottom:10px;">
            termId: <span th:text="${termId}"></span>
        </div>

        <div class="table-wrap">
            <table class="excel-table">
                <colgroup>
                    <col style="width:110px;">   <!-- 개설 -->
                    <col style="width:60px;">   <!-- 이수구분 -->
                    <col style="width:60px;">   <!-- 코드 -->
                    <col style="width:120px;">  <!-- 과목명 -->
                    <col style="width:40px;">   <!-- 분반 -->
                    <col style="width:50px;">  <!-- 교수 -->
                    <col style="width:70px;">   <!-- 대상 -->
                    <col style="width:35px;">   <!-- 학점 -->
                    <col style="width:35px;">   <!-- 정원 -->
                </colgroup>

                <thead>
                <tr>
                    <th>개설</th>
                    <th>이수구분</th>
                    <th>코드</th>
                    <th>과목명</th>
                    <th>분반</th>
                    <th>교수</th>
                    <th>대상</th>
                    <th>학점</th>

                </tr>
                </thead>

                <tbody>
                <tr th:each="c : ${courseList}"
                    class="course-row-js"
                    th:attr="data-course-id=${c.id}">

                    <td th:text="${c.opening}"></td>
                    <td th:text="${c.category}"></td>
                    <td th:text="${c.courseCode}" th:title="${c.courseCode}" ></td>
                    <td class="truncate" th:text="${c.courseName}"> </td>
                    <td th:text="${c.section}"></td>
                    <td th:text="${c.professor}" th:title="${c.professor}"> </td>
                    <td th:text="${c.target}" th:title="${c.target}"> </td>
                    <td th:text="${c.credits}"></td>

                </tr>
                </tbody>
            </table>
        </div>
    </div>

<!-- 시간표 -->
    <div class="panel timetable-panel" style="grid-row: 1 / span 2;">
        <h2>시간표</h2>

        <table class="timetable-grid">
            <thead>
            <tr>
                <th class="pcol">교시</th>
                <th th:each="d : ${days}" th:text="${d}"></th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="p : ${periods}">
                <th class="pcol">
                    <div th:text="${p}"></div>
                    <div class="period-time"
                         th:text="${periodTimeMap[p]}"></div>
                </th>

                <td th:each="d : ${days}">
                    <div class="cell"
                         th:with="
                      keyA=${d + '-' + p + 'A'},
                      keyB=${d + '-' + p + 'B'},
                      listA=${cellMap.get(keyA)},
                      listB=${cellMap.get(keyB)}
                       "th:classappend="${listA != null and listB != null} ? ' conflict' : ''">

                        <!-- A슬롯 -->
                        <div class="slot-label"
                            th:if="${listA == null or #lists.isEmpty(listA)}"
                            th:text="${p} + 'A'"></div>

                        <div th:if="${listA != null and !#lists.isEmpty(listA)}">
                            <div th:each="it : ${listA}">
                                <div class="course-pill"
                                     th:style="|background:${it.color};|"
                                     th:classappend="${it.continuation} ? ' cont' : ''">
                                    <span th:text="${it.text}"></span>
                                </div>
                            </div>
                        </div>

                        <hr/>
                        <!-- B슬롯 -->
                        <div class="slot-label"
                             th:if="${listB == null or #lists.isEmpty(listB)}"
                             th:text="${p} + 'B'"></div>

                        <div th:if="${listB != null and !#lists.isEmpty(listB)}">
                            <div th:each="it : ${listB}">
                                <div class="course-pill"
                                     th:style="|background:${it.color};|"
                                     th:text="${it.continuation ? '' : it.text}">
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>


    <!-- 담은 과목 목록 -->
    <div class="panel picked-panel">
        <h2>담은 과목</h2>

        <div th:if="${#lists.isEmpty(pickedCourseIds)}" class="small">
            목록에서 듣고싶은 강의를 추가하세요!
        </div>

        <div th:if="${!#lists.isEmpty(pickedCourseIds)}" class="table-wrap">
            <table class="excel-table">
                <colgroup>
                    <col style="width:110px;">   <!-- 개설 -->
                    <col style="width:60px;">   <!-- 이수구분 -->
                    <col style="width:60px;">   <!-- 코드 -->
                    <col style="width:120px;">  <!-- 과목명 -->
                    <col style="width:40px;">   <!-- 분반 -->
                    <col style="width:50px;">  <!-- 교수 -->
                    <col style="width:70px;">   <!-- 대상 -->
                    <col style="width:35px;">   <!-- 학점 -->
                    <col style="width:35px;">   <!-- 정원 -->
                    <col style="width:130px;">   <!-- 시간 -->

                </colgroup>

                <thead>
                <tr>
                    <th>개설</th>
                    <th>이수구분</th>
                    <th>코드</th>
                    <th>과목명</th>
                    <th>분반</th>
                    <th>교수</th>
                    <th>대상</th>
                    <th>학점</th>
                    <th>정원</th>
                    <th>시간</th>

                </tr>
                </thead>

                <tbody>
                <tr th:each="cid : ${pickedCourseIds}"
                    th:with="pc=${pickedCourseMap.get(cid)}"
                    class="picked-row-js"
                    th:attr="data-course-id=${cid}">

                    <!-- null도 깨지지 않게 수정 -->
                    <td th:text="${pc != null ? pc.opening : '-'}"></td>
                    <td th:text="${pc.category}"></td>

                    <td th:text="${pc != null ? pc.courseCode : '-'}"
                        th:title="${pc != null ? pc.courseCode : ''}"></td>
                    <td class="truncate" th:text="${pc != null ? pc.courseName : '(missing ' + cid + ')'}"></td>
                    <td th:text="${pc != null ? pc.section : '-'}"></td>
                    <td th:text="${pc != null ? pc.professor : '-'}"
                        th:title="${pc != null ? pc.professor : ''}"></td>
                    <td th:text="${pc != null ? pc.target : '-'}"
                        th:title="${pc != null ? pc.target : ''}"></td>
                    <td th:text="${pc != null ? pc.credits : '-'}"></td>
                    <td th:text="${pc != null ? pc.capacity : '-'}"></td>
                    <td th:text="${pc != null ? pc.rawTimeText : '-'}"></td>

                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    const timetableId = /*[[${timetable.id}]]*/ 0;

    console.log("[timetable] script loaded, timetableId =", timetableId);

    const csrfHeader = /*[[${_csrf != null ? _csrf.headerName : ''}]]*/ '';
    const csrfToken  = /*[[${_csrf != null ? _csrf.token : ''}]]*/ '';

    function post(url, bodyObj) {
        const headers = { "Content-Type": "application/x-www-form-urlencoded" };
        if (csrfHeader && csrfToken) headers[csrfHeader] = csrfToken;

        const body = new URLSearchParams(bodyObj).toString();

        return fetch(url, {
            method: "POST",
            headers,
            body
        });
    }

    // 강의 목록 더블클릭 -> 추가
    document.querySelectorAll("tr.course-row-js").forEach(tr => {
        tr.addEventListener("dblclick", async () => {
            const courseId = tr.dataset.courseId;
            console.log("[dblclick add]", { timetableId, courseId });

            try {
                const res = await post(`/timetable/${timetableId}/courses/add`, { courseId });
                if (!res.ok) {
                    const text = await res.text();
                    alert("추가 실패: " + res.status);
                    console.error("add failed", res.status, text);
                    return;
                }
                location.reload();
            } catch (e) {
                console.error("add error", e);
            }
        });
    });

    // 담은 과목 더블클릭 -> 삭제
    document.querySelectorAll("tr.picked-row-js").forEach(tr => {
        tr.addEventListener("dblclick", async () => {
            const courseId = tr.dataset.courseId;
            console.log("[dblclick remove]", { timetableId, courseId });

            try {
                const res = await post(`/timetable/${timetableId}/courses/remove`, { courseId });
                if (!res.ok) {
                    const text = await res.text();
                    alert("삭제 실패: " + res.status);
                    console.error("remove failed", res.status, text);
                    return;
                }
                location.reload();
            } catch (e) {
                console.error("remove error", e);
            }
        });
    });
    /*]]>*/
</script>

</body>
</html>
