<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>시간표</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 18px; background:#f7f9fc;}
        .topbar { display:flex; align-items:center; gap:10px; margin-bottom: 12px; }
        .topbar input { padding:6px 8px; width: 280px; }
        .topbar button { padding:6px 10px; cursor:pointer; }

        .layout {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            grid-template-rows: 1fr 0.55fr;
            gap: 18px;
            height: calc(100vh - 90px);
        }

        .panel {
            border-radius: 8px;
            background: #f3f7ff;
            padding: 14px;
            overflow: auto;
        }

        .panel h2 { margin: 0 0 10px 0; font-size: 22px; }

        .period-time {
            font-size: 11px;
            color: #8b94a7;
            font-weight: normal;
            margin-top: 2px;
        }

        .slot-label {
            font-weight: normal; /*얇게 변경...*/
            color: #444;
        }
        .course-row, .picked-row {
            display:flex; align-items:center; justify-content:space-between;
            background: rgba(255,255,255,0.8);
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            gap: 10px;
        }

        .course-row .meta, .picked-row .meta { font-size: 13px; color:#333; }
        .course-row button, .picked-row button { padding: 6px 10px; cursor:pointer; }

        /* timetable grid */
        table { width:100%; border-collapse: collapse; background:white; }
        th, td { border: 1px solid #cfd6e3; padding: 6px; vertical-align: top; }
        th { background: #f6f8fc; position: sticky; top: 0; z-index: 2; }
        .pcol { position: sticky; left:0; z-index: 1; background:#f6f8fc; }

        .cell { font-size: 12px; line-height: 1.25; min-height: 40px; }
        .conflict { background: #ffe3e3; }
        .small { font-size: 12px; color:#444; }
    </style>
</head>
<body>

<div class="topbar">
    <div class="small">timetableId: <span th:text="${timetable.id}"></span></div>

    <form th:action="@{|/timetable/${timetable.id}/title|}" method="post" style="display:flex; gap:8px; align-items:center;">
        <input type="text" name="title" th:value="${timetable.title}" />
        <button type="submit">제목 수정</button>
    </form>

    <form th:action="@{|/timetable/${timetable.id}/save|}" method="post">
        <button type="submit">저장</button>
    </form>
</div>

<div class="layout">

    <!-- 왼쪽 위: 강의 목록 -->
    <div class="panel">
        <h2>강의 목록</h2>

        <div class="small" style="margin-bottom:10px;">
            termId: <span th:text="${termId}"></span>
        </div>

        <div th:each="c : ${courseList}" class="course-row">
            <div>
                <div><b th:text="${c.courseName}"></b></div>
                <div class="meta"
                     th:text="${c.opening + ' / ' + c.courseCode + ' / ' + c.section + '분반 / ' + c.professor}">
                </div>
                <div class="meta" th:text="${c.rawTimeText}"></div>
            </div>

            <!-- 이미 담은 과목이면 버튼 비활성화 -->
            <form th:action="@{|/timetable/${timetable.id}/courses/add|}" method="post">
                <input type="hidden" name="courseId" th:value="${c.id}"/>
                <button type="submit"
                        th:disabled="${#lists.contains(pickedCourseIds, c.id)}"
                        th:text="${#lists.contains(pickedCourseIds, c.id)} ? '담김' : '추가'">
                </button>
            </form>
        </div>
    </div>

    <!-- 오른쪽: 시간표 -->
    <div class="panel" style="grid-row: 1 / span 2;">
        <h2>시간표</h2>

        <table>
            <thead>
            <tr>
                <th class="pcol">교시</th>
                <th th:each="d : ${days}" th:text="${d}"></th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="p : ${periods}">
                <th class="pcol">
                    <div th:text="${p}"></div>
                    <div class="period-time"
                         th:text="${periodTimeMap[p]}"></div>
                </th>

                <td th:each="d : ${days}">
                    <div class="cell"
                         th:with="
                  keyA=${d + '-' + p + 'A'},
                  keyB=${d + '-' + p + 'B'},
                  listA=${cellMap[keyA]},
                  listB=${cellMap[keyB]},
                  sizeA=${listA == null ? 0 : #lists.size(listA)},
                  sizeB=${listB == null ? 0 : #lists.size(listB)}
               "
                         th:classappend="${(sizeA + sizeB) > 1} ? ' conflict' : ''">

                        <div class="slot-label" th:text="${p} + 'A'"></div>
                        <div th:if="${listA != null}" th:each="x : ${listA}" th:text="${x}"></div>

                        <hr/>

                        <div class="slot-label" th:text="${p} + 'B'"></div>
                        <div th:if="${listB != null}" th:each="x : ${listB}" th:text="${x}"></div>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 왼쪽 아래: 내가 담은 과목들 -->
    <div class="panel">
        <h2>담은 과목</h2>

        <div th:if="${#lists.isEmpty(pickedCourseIds)}" class="small">
            목록에서 듣고싶은 강의를 추가하세요!
        </div>

        <div th:each="cid : ${pickedCourseIds}" class="picked-row"
             th:with="pc=${pickedCourseMap.get(cid)}">

            <div class="small" th:text="${pickedCourseMap.containsKey(cid)}"></div>
            <span th:text="${cid}"></span>

            <div>
                <span th:if="${pc != null}" th:text="${pc.courseName}"></span>
                <span th:if="${pc == null}" th:text="${'(missing course: ' + cid + ')'}"></span>

                <div class="meta" th:if="${pc != null}"
                     th:text="${pc.courseCode + ' / ' + pc.section + '분반'}"></div>

                <div class="meta" th:if="${pc == null}" th:text="'(no meta)'"></div>
            </div>

            <form th:action="@{|/timetable/${timetable.id}/courses/remove|}" method="post">
                <input type="hidden" name="courseId" th:value="${cid}"/>
                <button type="submit">삭제</button>
            </form>
        </div>

    </div>

</div>
</body>
</html>
