<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>시간표</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 18px; background:#f7f9fc;}
        .topbar { display:flex; align-items:center; gap:10px; margin-bottom: 12px; }
        .topbar input { padding:6px 8px; width: 280px; }
        .topbar button { padding:6px 10px; cursor:pointer; }

        .layout {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            grid-template-rows: 1fr 0.55fr;
            gap: 18px;
            height: calc(100vh - 90px);
        }

        .panel {
            border-radius: 8px;
            background: #f3f7ff;
            padding: 14px;
            overflow: auto;
        }

        .panel h2 { margin: 0 0 10px 0; font-size: 22px; }

        .period-time {
            font-size: 11px;
            color: #8b94a7;
            font-weight: normal;
            margin-top: 2px;
        }

        .slot-label {
            font-weight: normal; /*얇게 변경...*/
            color: #444;
        }
        .course-row, .picked-row {
            display:flex; align-items:center; justify-content:space-between;
            background: rgba(255,255,255,0.8);
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            gap: 10px;
        }

        .course-row .meta, .picked-row .meta { font-size: 13px; color:#333; }
        .course-row button, .picked-row button { padding: 6px 10px; cursor:pointer; }

        /* timetable grid */
        table { width:100%; border-collapse: collapse; background:white; }
        th, td { border: 1px solid #cfd6e3; padding: 6px; vertical-align: top; }
        th { background: #f6f8fc; position: sticky; top: 0; z-index: 2; }
        .pcol { position: sticky; left:0; z-index: 1; background:#f6f8fc; }

        .cell { font-size: 12px; line-height: 1.25; min-height: 40px; }
        .conflict { background: #ffe3e3; }
        .small { font-size: 12px; color:#444; }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 13px;
            table-layout:fixed;
        }
        .excel-table th,
        .excel-table td {
            border: 1px solid #cfd6e3;
            padding: 8px 10px;
            text-align: left;
            vertical-align: middle;

            white-space: nowrap; /* 한 줄 유지 */
            overflow:hidden; /* 넘치는 텍스트는 숨기기 */
            /*text-overflow:ellipsis; !* ... 표시하기 *!*/
        }
        .excel-table th {
            background: #f6f8fc;
            position: sticky;
            top: 0;
            z-index: 2;
            font-weight: 700;
        }

        .truncate {
            max-width: 220px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .excel-table tbody tr { cursor: pointer; }
        .excel-table tbody tr:hover { background: #eef4ff; }

        /* 이미 담긴 과목은 회색 처리 */
        .excel-table tbody tr.picked {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .excel-table tbody tr.picked:hover {
            background: inherit;
        }


        .table-wrap { overflow: auto; }
    </style>
</head>
<body>

<div class="topbar">
    <div class="small">timetableId: <span th:text="${timetable.id}"></span></div>

    <form th:action="@{|/timetable/${timetable.id}/title|}" method="post" style="display:flex; gap:8px; align-items:center;">
        <input type="text" name="title" th:value="${timetable.title}" />
        <button type="submit">제목 수정</button>
    </form>

    <form th:action="@{|/timetable/${timetable.id}/save|}" method="post">
        <button type="submit">저장</button>
    </form>
</div>

<div class="layout">

    <!-- 강의 목록 -->
    <div class="panel">
        <h2>강의 목록</h2>

        <div class="small" style="margin-bottom:10px;">
            termId: <span th:text="${termId}"></span>
        </div>

        <div class="table-wrap">
            <table class="excel-table">
                <colgroup>
                    <col style="width:110px;">   <!-- 개설 -->
                    <col style="width:60px;">   <!-- 코드 -->
                    <col style="width:120px;">  <!-- 과목명 -->
                    <col style="width:40px;">   <!-- 분반 -->
                    <col style="width:50px;">  <!-- 교수 -->
                    <col style="width:70px;">   <!-- 대상 -->
                    <col style="width:35px;">   <!-- 학점 -->
                    <col style="width:35px;">   <!-- 정원 -->
                </colgroup>

                <thead>
                <tr>
                    <th>개설</th>
                    <th>코드</th>
                    <th>과목명</th>
                    <th>분반</th>
                    <th>교수님</th>
                    <th>대상</th>
                    <th>학점</th>
                    <th>정원</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="c : ${courseList}"
                    class="course-row-js"
                    th:attr="data-course-id=${c.id}">

                    <td th:text="${c.opening}"></td>
                    <td th:text="${c.courseCode}" th:title="${c.courseCode}" ></td>
                    <td class="truncate" th:text="${c.courseName}"> </td>
                    <td th:text="${c.section}"></td>
                    <td th:text="${c.professor}" th:title="${c.professor}"> </td>
                    <td th:text="${c.target}" th:title="${c.target}"> </td>
                    <td th:text="${c.credits}"></td>
                    <td th:text="${c.capacity}"></td>

<!--                    &lt;!&ndash; 숨겨진 과목 추가 기능(더블클릭) &ndash;&gt;-->
<!--                    <td style="display:none;">-->
<!--                        <form th:action="@{|/timetable/${timetable.id}/courses/add|}" method="post">-->
<!--                            <input type="hidden" name="courseId" th:value="${c.id}"/>-->
<!--                        </form>-->
<!--                    </td>-->
                </tr>
                </tbody>
            </table>
        </div>
    </div>

<!-- 시간표 -->
    <div class="panel" style="grid-row: 1 / span 2;">
        <h2>시간표</h2>

        <table>
            <thead>
            <tr>
                <th class="pcol">교시</th>
                <th th:each="d : ${days}" th:text="${d}"></th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="p : ${periods}">
                <th class="pcol">
                    <div th:text="${p}"></div>
                    <div class="period-time"
                         th:text="${periodTimeMap[p]}"></div>
                </th>

                <td th:each="d : ${days}">
                    <div class="cell"
                         th:with="
                  keyA=${d + '-' + p + 'A'},
                  keyB=${d + '-' + p + 'B'},
                  listA=${cellMap[keyA]},
                  listB=${cellMap[keyB]},
                  sizeA=${listA == null ? 0 : #lists.size(listA)},
                  sizeB=${listB == null ? 0 : #lists.size(listB)}
               "
                         th:classappend="${(sizeA + sizeB) > 1} ? ' conflict' : ''">

                        <div class="slot-label" th:text="${p} + 'A'"></div>
                        <div th:if="${listA != null}" th:each="x : ${listA}" th:text="${x}"></div>

                        <hr/>

                        <div class="slot-label" th:text="${p} + 'B'"></div>
                        <div th:if="${listB != null}" th:each="x : ${listB}" th:text="${x}"></div>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 담은 과목 목록 -->
    <div class="panel">
        <h2>담은 과목</h2>

        <div th:if="${#lists.isEmpty(pickedCourseIds)}" class="small">
            목록에서 듣고싶은 강의를 추가하세요!
        </div>

        <div th:if="${!#lists.isEmpty(pickedCourseIds)}" class="table-wrap">
            <table class="excel-table">
                <colgroup>
                    <col style="width:110px;">   <!-- 개설 -->
                    <col style="width:60px;">   <!-- 코드 -->
                    <col style="width:120px;">  <!-- 과목명 -->
                    <col style="width:40px;">   <!-- 분반 -->
                    <col style="width:50px;">  <!-- 교수 -->
                    <col style="width:70px;">   <!-- 대상 -->
                    <col style="width:35px;">   <!-- 학점 -->
                    <col style="width:35px;">   <!-- 정원 -->
                </colgroup>

                <thead>
                <tr>
                    <th>개설</th>
                    <th>코드</th>
                    <th>과목명</th>
                    <th>분반</th>
                    <th>교수</th>
                    <th>대상</th>
                    <th>학점</th>
                    <th>정원</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="cid : ${pickedCourseIds}"
                    th:with="pc=${pickedCourseMap.get(cid)}"
                    class="picked-row-js"
                    th:attr="data-course-id=${cid}">

                    <!-- null도 깨지지 않게 수정 -->
                    <td th:text="${pc != null ? pc.opening : '-'}"></td>
                    <td th:text="${pc != null ? pc.courseCode : '-'}"
                        th:title="${pc != null ? pc.courseCode : ''}"></td>
                    <td class="truncate" th:text="${pc != null ? pc.courseName : '(missing ' + cid + ')'}"></td>
                    <td th:text="${pc != null ? pc.section : '-'}"></td>
                    <td th:text="${pc != null ? pc.professor : '-'}"
                        th:title="${pc != null ? pc.professor : ''}"></td>
                    <td th:text="${pc != null ? pc.target : '-'}"
                        th:title="${pc != null ? pc.target : ''}"></td>
                    <td th:text="${pc != null ? pc.credits : '-'}"></td>
                    <td th:text="${pc != null ? pc.capacity : '-'}"></td>

<!--                    &lt;!&ndash; 숨겨진 과목 제거 기능(더블클릭) &ndash;&gt;-->
<!--                    <td style="display:none;">-->
<!--                        <form th:action="@{|/timetable/${timetable.id}/courses/remove|}" method="post">-->
<!--                            <input type="hidden" name="courseId" th:value="${cid}"/>-->
<!--                        </form>-->
<!--                    </td>-->
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    const timetableId = /*[[${timetable.id}]]*/ 0;

    console.log("[timetable] script loaded, timetableId =", timetableId);

    // CSRF(스프링 시큐리티 켜져있으면 필요)
    const csrfHeader = /*[[${_csrf != null ? _csrf.headerName : ''}]]*/ '';
    const csrfToken  = /*[[${_csrf != null ? _csrf.token : ''}]]*/ '';

    function post(url, bodyObj) {
        const headers = { "Content-Type": "application/x-www-form-urlencoded" };
        if (csrfHeader && csrfToken) headers[csrfHeader] = csrfToken;

        const body = new URLSearchParams(bodyObj).toString();

        return fetch(url, {
            method: "POST",
            headers,
            body
        });
    }

    // 강의 목록 더블클릭 -> 추가
    document.querySelectorAll("tr.course-row-js").forEach(tr => {
        tr.addEventListener("dblclick", async () => {
            const courseId = tr.dataset.courseId;
            console.log("[dblclick add]", { timetableId, courseId });

            try {
                const res = await post(`/timetable/${timetableId}/courses/add`, { courseId });
                if (!res.ok) {
                    const text = await res.text();
                    alert("추가 실패: " + res.status);
                    console.error("add failed", res.status, text);
                    return;
                }
                location.reload();
            } catch (e) {
                console.error("add error", e);
            }
        });
    });

    // 담은 과목 더블클릭 -> 삭제
    document.querySelectorAll("tr.picked-row-js").forEach(tr => {
        tr.addEventListener("dblclick", async () => {
            const courseId = tr.dataset.courseId;
            console.log("[dblclick remove]", { timetableId, courseId });

            try {
                const res = await post(`/timetable/${timetableId}/courses/remove`, { courseId });
                if (!res.ok) {
                    const text = await res.text();
                    alert("삭제 실패: " + res.status);
                    console.error("remove failed", res.status, text);
                    return;
                }
                location.reload();
            } catch (e) {
                console.error("remove error", e);
            }
        });
    });
    /*]]>*/
</script>

</body>
</html>
